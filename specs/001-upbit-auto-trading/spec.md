# Feature Specification: Upbit 자동매매 — 전략·백테스트·자동매매·로깅

**Feature Branch**: `001-upbit-auto-trading`  
**Created**: 2025-10-26  
**Status**: Draft  
**Input**: User description: "암호화폐 코인 자동 매매야 특정 전략을 만들고 백테스트하고 해당 전략을 선택해서 자동매매를
  돌리고 로깅을 남겨서 어떻게 샀고 손실을 봤거나 이득을 봤거나 승률이 얼마인지 이렇게 알수있는거 그리고 https://docs.upbit.com/kr/llms.txt 을 통해 api를 사용해서 구현해야해"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 전략 설계·백테스트·전략 선택 (Priority: P1)

사용자는 전략 파라미터를 정의하고 과거 캔들 데이터로 백테스트를 실행해 핵심 지표(수익률, 최대낙폭, 승률, 거래수, 비용)를 확인한다. 결과를 비교해 원하는 전략 구성을 선택한다.

**Why this priority**: 실거래 전 성과 검증과 재현성 확보가 필수이기 때문.

**Independent Test**: CSV 또는 제공 데이터셋으로 백테스트 실행 → JSON 지표 파일 생성 → 지표 값 검증만으로 가치 입증 가능.

**Acceptance Scenarios**:

1. Given 전략 파라미터가 제공되고 캔들 CSV가 있을 때, When 백테스트를 실행하면, Then 지표 JSON이 생성되고 수익률·승률·MDD가 포함된다.
2. Given 동일 데이터·동일 파라미터일 때, When 백테스트를 두 번 실행하면, Then 지표가 결정적으로 동일하다(재현성).

---

### User Story 2 - 자동매매 실행(페이퍼→라이브) (Priority: P2)

사용자는 백테스트로 선택한 전략을 페이퍼 트레이딩으로 먼저 돌려보고, 안전장치 확인 후 명시적으로 라이브 거래를 시작한다.

**Why this priority**: 자산 보호와 운영 안전성 확보가 핵심.

**Independent Test**: 페이퍼 모드에서 신호→주문→체결 시퀀스와 리스크 한도 동작만으로 가치를 입증 가능.

**Acceptance Scenarios**:

1. Given 페이퍼 모드로 실행 중일 때, When 전략이 매수 신호를 내면, Then 가상 포지션이 열리고 주문/체결 로그가 기록된다.
2. Given 일간 손실 한도에 도달했을 때, When 추가 신호가 발생해도, Then 신규 주문이 차단되고 안전 정지 상태가 기록된다.

---

### User Story 3 - 로깅·리포트로 성과 파악 (Priority: P3)

사용자는 실행 로그(주문, 체결, 포지션, PnL, 승률)를 기반으로 사람이 읽기 쉬운 요약 리포트를 확인한다.

**Why this priority**: 전략 개선과 운영 회고에 필수.

**Independent Test**: 로그(JSON Lines)에서 주요 이벤트를 집계해 요약만 출력해도 가치 입증 가능.

**Acceptance Scenarios**:

1. Given 백테스트/실행이 완료됐을 때, When 리포트를 생성하면, Then 전략/기간/지표 요약이 표준 포맷으로 출력된다.
2. Given 여러 실행 결과가 있을 때, When 집계를 요청하면, Then 전략별/기간별 핵심 지표가 비교 가능하게 정리된다.

---

### Edge Cases

- 업비트 API 속도 제한 및 429 응답: 백오프/재시도, 쿼터 초과 시 중단·재개 정책
- 네트워크 장애/시간 동기화 문제: 재연결, UTC/Asia/Seoul 변환, 클럭 드리프트 경계
- 최소 주문 수량/가격 단위 규칙: 라운딩·유효성 검사 실패 처리
- 부분 체결/중복 주문/재진입 쿨다운: 주문 상태 일관성 보장, 멱등키 사용
- 시세 데이터 결측/불연속: 보정/스킵 정책과 로그 남김
- WebSocket 끊김/버퍼 지연: 재구독, 최신 시세 확인 수단
- 인증 키 오류/권한 부족: 즉시 중단, 사용자 피드백과 보안 가이드

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 사용자는 CLI로 전략을 선택/파라미터 지정하여 백테스트를 실행할 수 있어야 한다.
- **FR-002**: 백테스트 결과는 결정적이어야 하며 핵심 지표(수익률, 최대낙폭, 승률, 거래수, 비용)를 포함해야 한다.
- **FR-003**: 시스템은 CSV 및 업비트 캔들 데이터를 입력으로 지원해야 한다.
- **FR-004**: 사용자는 선택한 전략으로 페이퍼 트레이딩을 실행할 수 있어야 한다(주문/체결 시뮬레이션, 리스크 한도 적용).
- **FR-005**: 라이브 트레이딩은 명시적 플래그와 2단계 확인 없이는 절대 실행되지 않아야 한다(기본 비활성화).
- **FR-006**: 리스크 제어(포지션 한도, 일간 손실 한도, 동시 포지션 수, 중복 주문 방지, 재진입 쿨다운)를 제공해야 한다.
- **FR-007**: 모든 주요 이벤트(신호, 주문, 체결, 포지션 변경, PnL)는 구조화 로그(JSON Lines)로 기록되어야 한다.
- **FR-008**: 리포트는 실행 디렉터리에 지표 요약(JSON)과 사람이 읽을 수 있는 요약을 생성해야 한다.
- **FR-009**: 업비트 API(문서: https://docs.upbit.com/kr/llms.txt) 사용 규약(인증, 속도 제한, 오류 코드)을 준수해야 한다.
- **FR-010**: 구성은 기본값 + 설정파일 + 환경변수 + CLI 플래그가 계층적으로 병합되어야 한다.
- **FR-011**: 시간대/타임스탬프 처리는 UTC 기준 저장, Asia/Seoul 표시를 명확히 지원해야 한다.
- **FR-012**: 데이터 스냅샷에 버전 태그를 부여해 재현 가능성을 보장해야 한다.
- **FR-013**: 실패 시 안전 정지(fail-safe)와 재시작 가능 상태 저장을 제공해야 한다.
- **FR-014**: 전략은 플러그인 형태로 등록/발견 가능하고 파라미터 스키마를 노출해야 한다.

*Clarifications (max 3)*

- **FR-015**: 초기 지원 마켓/타임프레임은 KRW-BTC 및 1/3/5/15/60분봉으로 한다.
- **FR-016**: 슬리피지/수수료는 고정 비율을 사용한다. 기본값: 수수료 0.05%, 슬리피지 0.05% (총 비용 0.1%).
- **FR-017**: 리포트 출력은 JSON 파일과 Markdown 요약을 모두 생성한다.

### Key Entities *(include if feature involves data)*

- **Candle**: 시가/고가/저가/종가/거래량, 타임스탬프(UTC)
- **Strategy**: 식별자, 파라미터 스키마, 신호 생성 규칙
- **Signal**: 매수/매도/보유, 근거(지표/임계값), 생성 시각
- **Order**: 주문 ID, 마켓, 수량, 가격, 유형(시장/지정), 상태, 멱등키
- **Fill**: 체결 ID, 체결 수량/가격, 수수료, 체결 시각
- **Position**: 포지션 ID, 방향/수량/진입가, 미실현/실현 PnL, 상태
- **Portfolio**: 현금, 자산 평가, 리스크 한도
- **Run**: 실행 ID, 모드(백테스트/페이퍼/라이브), 전략/파라미터, 시작/종료 시각, 결과 경로
- **Metrics**: 수익률, MDD, 승률, 거래수, 샤프/소르티노(가능시), 비용

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 사용자는 동일 입력(데이터·파라미터)으로 백테스트 재실행 시 지표 값이 100% 동일하다(결정성).
- **SC-002**: P1 시나리오(백테스트→전략 선택)는 사용 설명서 없이 10분 내 완료 가능하다(가시성/단순성).
- **SC-003**: 백테스트 결과는 핵심 지표 6가지(수익률, MDD, 승률, 거래수, 비용, 평균 거래 성과)를 포함해 파일로 저장된다.
- **SC-004**: 페이퍼 트레이딩 중 리스크 한도(일간 손실 또는 포지션 한도) 초과 시 신규 주문이 차단되고 원인과 시각이 로그에 남는다.
- **SC-005**: 라이브 모드는 명시적 플래그와 2단계 확인 없이 절대 실행되지 않으며, 보호 장치 동작이 로그로 검증 가능하다.
- **SC-006**: 최소 5만 캔들 규모 데이터로 백테스트 시, 기본 환경에서 사용자 체감 대기 시간이 합리적(예: 60초 이내)이다.
